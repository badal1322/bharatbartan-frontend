<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Cart - BharatBartan</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    body {
      background: linear-gradient(to bottom, #0a0a23, #1f1f2e);
      font-family: 'Georgia', serif;
    }
  </style>
</head>
<body class="text-white">
  <div id="navbar"></div>

  <!-- Cart Section -->
  <section class="py-10 px-6 max-w-4xl mx-auto">
    <h2 class="text-3xl font-bold text-yellow-400 mb-6">Your Cart</h2>
    <div id="cartContainer" class="space-y-4"></div>

    <div id="totalAmount" class="text-xl font-semibold mt-8"></div>
    <button onclick="sendOrderToBackend()" class="inline-block mt-6 bg-yellow-500 text-black font-bold px-6 py-2 rounded hover:bg-yellow-600 transition">Proceed to Checkout</button>
  </section>

  <div id="footer"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const cartContainer = document.getElementById("cartContainer");
      const totalAmount = document.getElementById("totalAmount");

      function loadCart() {
        const cart = JSON.parse(localStorage.getItem("cart") || "[]");
        cartContainer.innerHTML = "";
        let total = 0;

        cart.forEach((item, index) => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;

          const div = document.createElement("div");
          div.className = "bg-black text-white p-4 rounded shadow border border-gray-700";
          div.innerHTML = `
            <div class="flex items-center gap-4">
              <img src="assets/${item.title.toLowerCase().replace(/\s+/g, '-')}.jpg" alt="${item.title}" class="w-16 h-16 object-cover rounded border border-gray-500">
              <div>
                <h3 class="text-lg font-bold font-serif">${item.title}</h3>
                <p class="text-sm">Unit Price: â‚¹${item.price}</p>
                <div class="flex items-center space-x-2 my-2">
                  <button class="bg-gray-300 text-black px-2 rounded" onclick="updateQty(${index}, -1)">-</button>
                  <span>${item.quantity}</span>
                  <button class="bg-gray-300 text-black px-2 rounded" onclick="updateQty(${index}, 1)">+</button>
                </div>
                <p class="text-sm">Total: â‚¹${itemTotal}</p>
              </div>
            </div>
          `;
          cartContainer.appendChild(div);
        });

        totalAmount.innerText = "Total: â‚¹" + total;

        const payButton = document.createElement("button");
        payButton.innerText = "Pay â‚¹" + total + " Online";
        payButton.className = "block mt-4 bg-green-500 text-white font-semibold px-6 py-2 rounded hover:bg-green-600 transition";
        payButton.onclick = () => {
          console.log("âœ… Pay button clicked");
          fetch("https://bharatbartan-backend.onrender.com/api/create-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ totalAmount: total })
          })
            .then(res => res.json())
            .then(order => {
              console.log(order);
              console.log("ðŸ”‘ Fetching Razorpay key...");
              fetch("https://bharatbartan-backend.onrender.com/api/get-razorpay-key")
                .then(res => res.json())
                .then(data => {
                  console.log(data.key);
                  const options = {
                    key: data.key,
                    amount: order.amount,
                    currency: order.currency,
                    name: "BharatBartan",
                    description: "Cart Checkout",
                    order_id: order.orderId,
                    handler: function (response) {
                      fetch("https://bharatbartan-backend.onrender.com/api/verify-payment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                          razorpay_order_id: response.razorpay_order_id,
                          razorpay_payment_id: response.razorpay_payment_id,
                          razorpay_signature: response.razorpay_signature
                        })
                      })
                        .then(res => res.json())
                        .then(data => {
                          if (data.verified) {
                            alert("âœ… Payment Verified Successfully!");
                            sendOrderToBackend();
                          } else {
                            alert("âŒ Payment verification failed.");
                          }
                        })
                        .catch(err => {
                          console.error("Verification error:", err);
                          alert("Error verifying payment.");
                        });
                    },
                    prefill: {
                      name: "Customer",
                      email: "customer@example.com",
                      contact: "9999999999"
                    },
                    theme: {
                      color: "#F37254"
                    }
                  };
                  console.log("ðŸ§¾ Opening Razorpay checkout...");
                  const rzp = new Razorpay(options);
                  rzp.open();
                });
            })
            .catch(err => {
              console.error("Error creating Razorpay order:", err);
              alert("Unable to initiate payment.");
            });
        };
        cartContainer.appendChild(payButton);
      }

      function sendOrderToBackend() {
        const cart = JSON.parse(localStorage.getItem("cart") || "[]");
        const orderData = {
          items: cart,
          timestamp: new Date().toISOString()
        };

        fetch("https://bharatbartan-backend.onrender.com/api/save-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(orderData)
        })
        .then(res => res.json())
        .then(data => {
          console.log("Order saved:", data);
          // Optionally redirect to success page
          window.location.href = "success.html";
        })
        .catch(err => {
          console.error("Order save failed:", err);
        });
      }

      window.updateQty = (index, change) => {
        const cart = JSON.parse(localStorage.getItem("cart") || "[]");
        cart[index].quantity += change;
        if (cart[index].quantity <= 0) cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        loadCart();
      };

      loadCart();
    });
  </script>
  <script>
    fetch("navbar.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("navbar").innerHTML = data;
      });

    fetch("footer.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("footer").innerHTML = data;
      });
  </script>
</body>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</html>